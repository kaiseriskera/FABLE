# todos: move to config.xml
# export _JAVA_OPTIONS="-Xmx1g"
rule prep_data:
    input: 
        "/datastore/homes3/s1804374/kai_lambda/fastqgz_files.fastq.gz/{sample}.fastq.gz"
    output: 
        "data/{sample}.fastq.gz"
    shell: 
        "cp {input} {output}"

rule porechop:
    input: 
        "data/{sample}.fastq.gz"
    output: 
        "data/pc_{sample}.fastq.gz"
    shell: 
        "porechop -i {input} -o {output}"
        
rule nanofilt:
    input: 
        "data/pc_{sample}.fastq.gz"
    output:
        "data/PCNF_{sample}.fastq.gz"
    shell:
        "gunzip -c {input} | NanoFilt -q 10 | gzip > {output}"

rule fastqc:
    input:
        "data/PCNF_{sample}.fastq.gz"
    output:
        "report/PCNF_{sample}_fastqc.html",
        "report/PCNF_{sample}_fastqc.zip"
    shell:
        "fastqc --threads 8 --outdir report {input}"
    
rule nanoplot:
    input:
        "data/PCNF_{sample}.fastq.gz"
    output:
        "report/PCNF_{sample}_NanoPlot-report.html",
        "report/PCNF_{sample}_NanoStats.txt"
    shell:
        "NanoPlot -t 8 --fastq {input} --outdir report"
      
rule vulcan:
    input:
        "data/PCNF_{sample}.fastq.gz"
    output:
        "data/vulcan_PCNF_{sample}.bam"
    shell:
        "vulcan -ont -t 10 -i {input} -r {reference} -o {output}"

rule bam_index:
    input:
        "data/vulcan_PCNF_{sample}.bam"
    output:
        "data/idx_vulcan_PCNF_{sample}.bam.bai",
        "data/idx_vulcan_PCNF_{sample}.bam"
    shell:
        "samtools sort {input} -o {output}"

rule NanoPlot:
    input:
        "data/idx_vulcan_PCNF_{sample}.bam"
    output:
        "report/vulcan_PCNF_{sample}_NanoPlot-report.html",
        "report/vulcan_PCNF_{sample}_NanoStats.txt"
    shell:
        "NanoPlot -t 8 --bam {input}"